<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flask API í…ŒìŠ¤íŠ¸</title>
    <script>
      const API_BASE_URL = "http://localhost:5001/api";

      // âœ… íšŒì›ê°€ì… ìš”ì²­
      function registerUser() {
        const data = {
          lab_name: document.getElementById("reg_lab_name").value,
          cohort_name: document.getElementById("reg_cohort_name").value,
          student_name: document.getElementById("reg_student_name").value,
          password: document.getElementById("reg_password").value,
          password_confirm: document.getElementById("reg_password_confirm")
            .value,
        };

        fetch(`${API_BASE_URL}/auth/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => alert(data.message))
          .catch((error) => console.error("Error:", error));
      }

      // âœ… ë¡œê·¸ì¸ ìš”ì²­
      function loginUser() {
        const data = {
          lab_name: document.getElementById("login_lab_name").value,
          cohort_name: document.getElementById("login_cohort_name").value,
          password: document.getElementById("login_password").value,
        };

        fetch(`${API_BASE_URL}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.token) {
              localStorage.setItem("token", data.token);
              alert("ë¡œê·¸ì¸ ì„±ê³µ!");
            } else {
              alert(data.message);
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // âœ… ê²Œì‹œê¸€ ì‘ì„± ìš”ì²­
      function createPost() {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          return;
        }

        const formData = new FormData();
        formData.append("title", document.getElementById("post_title").value);
        formData.append(
          "category",
          document.getElementById("post_category").value
        );
        formData.append(
          "status",
          document.getElementById("post_status").checked ? "true" : "false"
        );
        formData.append("price", document.getElementById("post_price").value);
        formData.append(
          "description",
          document.getElementById("post_description").value
        );

        const imageInput = document.getElementById("post_image");
        if (imageInput.files.length > 0) {
          formData.append("image", imageInput.files[0]);
        }

        // âœ… ëª¨ë“  í•„ë“œê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if (
          !title &&
          !category &&
          !description &&
          !imageInput.files.length &&
          (!price || Number(price) === 0)
        ) {
          alert("âŒ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // âœ… ê°€ê²©ì´ 0 ì´ìƒì¸ì§€ í™•ì¸
        if (isNaN(price) || Number(price) < 0) {
          alert("âŒ ê°€ê²©ì€ 0 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        fetch(`${API_BASE_URL}/posts`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        })
          .then((response) =>
            response
              .json()
              .then((data) => ({ status: response.status, body: data }))
          )
          .then(({ status, body }) => {
            if (status === 201) {
              alert("ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
              console.log(body);
              fetchPosts(); // âœ… ê²Œì‹œê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
              alert(`âŒ ì˜¤ë¥˜: ${body.message}`);
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // âœ… ì „ì²´ ê²Œì‹œê¸€ ì¡°íšŒ
      function fetchPosts() {
        fetch(`${API_BASE_URL}/posts`)
          .then((response) => response.json())
          .then((data) => {
            let postList = document.getElementById("post_list");
            postList.innerHTML = "";
            data.forEach((post) => {
              let item = document.createElement("li");
              item.innerHTML = `<strong>${post.title}</strong> - ${post.nick_name}`;
              item.onclick = () => fetchPostDetail(post.id);
              postList.appendChild(item);
            });
          })
          .catch((error) => console.error("Error:", error));
      }

      // âœ… íŠ¹ì • ê²Œì‹œê¸€ ì¡°íšŒ + ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë Œë”ë§
      function fetchPostDetail(postId) {
        const token = localStorage.getItem("token");

        fetch(`${API_BASE_URL}/posts/${postId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("detail_title").innerText = data.title;
            document.getElementById("detail_title").dataset.postId = postId;
            document.getElementById("detail_category").innerText =
              data.category;
            document.getElementById("detail_price").innerText = data.price;
            document.getElementById("detail_description").innerText =
              data.description;
            document.getElementById("detail_nickname").innerText =
              data.nick_name;
            document.getElementById("detail_created_at").innerText = new Date(
              data.created_at
            ).toLocaleString();

            // âœ… ì´ë¯¸ì§€ í‘œì‹œ
            const imageElement = document.getElementById("detail_image");
            if (data.image_url) {
              imageElement.src = `http://localhost:5001${data.image_url}`;
              imageElement.style.display = "block";
            } else {
              imageElement.style.display = "none";
            }

            // âœ… ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë Œë”ë§
            const editDeleteButtons = document.getElementById(
              "edit_delete_buttons"
            );
            if (data.isAuthor) {
              editDeleteButtons.style.display = "block"; // ë³¸ì¸ ê²Œì‹œê¸€ì´ë©´ ë²„íŠ¼ í‘œì‹œ
            } else {
              editDeleteButtons.style.display = "none"; // ë‹¤ë¥¸ ì‚¬ëŒì´ë©´ ìˆ¨ê¹€
            }

            // âœ… ëŒ“ê¸€ ëª©ë¡ í‘œì‹œ
            renderComments(data.comments, postId);
          })
          .catch((error) => console.error("Error:", error));
      }

      // âœ… ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
      function renderComments(comments, postId) {
        const commentList = document.getElementById("comment_list");
        commentList.innerHTML = "";

        comments.forEach((comment) => {
          let commentItem = document.createElement("li");
          commentItem.innerHTML = `
                    <strong>${comment.writer}</strong> (${new Date(
            comment.created_at
          ).toLocaleString()}): ${comment.content}
                    <ul id="replies_${comment.id}"></ul>
                    <div id="reply_input_${comment.id}" style="display:none;">
                        <input type="text" id="reply_content_${
                          comment.id
                        }" placeholder="ëŒ€ëŒ“ê¸€ ì…ë ¥">
                    </div>
                `;

          // âœ… "ë‹µê¸€ ë‹¬ê¸°" ë²„íŠ¼ ë™ì ìœ¼ë¡œ ìƒì„±
          const replyButton = document.createElement("button");
          replyButton.innerText = "ë‹µê¸€ ë‹¬ê¸°";
          replyButton.addEventListener("click", function () {
            showReplyInput(postId, comment.id);
          });
          commentItem.appendChild(replyButton);

          // âœ… "ì‘ì„±" ë²„íŠ¼ ë™ì ìœ¼ë¡œ ìƒì„±
          const postReplyButton = document.createElement("button");
          postReplyButton.innerText = "ì‘ì„±";
          postReplyButton.addEventListener("click", function () {
            postReply(postId, comment.id);
          });

          // âœ… "ì‘ì„±" ë²„íŠ¼ì„ reply_input ì˜ì—­ì— ì¶”ê°€
          const replyInputDiv = commentItem.querySelector(
            `#reply_input_${comment.id}`
          );
          replyInputDiv.appendChild(postReplyButton);

          // âœ… ğŸ›  ëŒ€ëŒ“ê¸€ì„ ì¶”ê°€í•  <ul>ì„ ë¯¸ë¦¬ ìƒì„±
          let repliesList = document.getElementById(`replies_${comment.id}`);
          if (!repliesList) {
            repliesList = document.createElement("ul");
            repliesList.id = `replies_${comment.id}`;
            commentItem.appendChild(repliesList);
          }

          commentList.appendChild(commentItem);

          // âœ… ëŒ€ëŒ“ê¸€ ì¶”ê°€
          comment.replies.forEach((reply) => {
            let replyItem = document.createElement("li");
            replyItem.innerHTML = `<strong>${reply.writer}</strong>: ${
              reply.content
            } (${new Date(reply.created_at).toLocaleString()})`;

            repliesList.appendChild(replyItem);
          });
        });
      }

      // âœ… ëŒ“ê¸€ ì‘ì„±
      function postComment() {
        const token = localStorage.getItem("token");
        const postId = document.getElementById("detail_title").dataset.postId;
        const content = document.getElementById("comment_content").value.trim();

        if (!content) {
          alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        fetch(`${API_BASE_URL}/posts/${postId}/comments`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ content }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            fetchPostDetail(postId); // âœ… ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          })
          .catch((error) => console.error("Error:", error));
      }

      // âœ… ëŒ€ëŒ“ê¸€ ì…ë ¥ í•„ë“œ í‘œì‹œ
      function showReplyInput(postId, commentId) {
        console.log("ğŸ“Œ [DEBUG] showReplyInput ì‹¤í–‰ë¨:", { postId, commentId });

        const replyInputDiv = document.getElementById(
          `reply_input_${commentId}`
        );
        if (replyInputDiv) {
          replyInputDiv.style.display = "block";
        } else {
          console.error(
            "âŒ [ERROR] reply_input divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:",
            commentId
          );
        }
      }

      // âœ… ëŒ€ëŒ“ê¸€ ì‘ì„±
      function postReply(postId, commentId) {
        console.log("ğŸ“Œ [DEBUG] postReply ì‹¤í–‰ë¨:", { postId, commentId });

        const token = localStorage.getItem("token");
        const content = document
          .getElementById(`reply_content_${commentId}`)
          .value.trim();

        if (!content) {
          alert("ëŒ€ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        fetch(`${API_BASE_URL}/posts/${postId}/comments/${commentId}/replies`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ content }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert("ëŒ€ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            fetchPostDetail(postId); // âœ… ëŒ€ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          })
          .catch((error) => console.error("âŒ [ERROR] postReply ì‹¤íŒ¨:", error));
      }

      function editPost() {
        const token = localStorage.getItem("token");
        const postId = document.getElementById("detail_title").dataset.postId; // âœ… ìˆ˜ì •

        if (!postId) {
          alert("ê²Œì‹œê¸€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const newTitle = prompt(
          "ìƒˆë¡œìš´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”",
          document.getElementById("detail_title").innerText
        );
        if (!newTitle) return;

        fetch(`${API_BASE_URL}/posts/${postId}`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ title: newTitle }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert("ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            fetchPostDetail(postId); // âœ… ìˆ˜ì • í›„ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          })
          .catch((error) => console.error("Error:", error));
      }

      function deletePost() {
        const token = localStorage.getItem("token");
        const postId = document.getElementById("detail_title").dataset.postId; // âœ… ìˆ˜ì •

        if (!postId) {
          alert("ê²Œì‹œê¸€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`${API_BASE_URL}/posts/${postId}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.href = "/"; // âœ… ì‚­ì œ í›„ ë©”ì¸ í˜ì´ì§€ ì´ë™
          })
          .catch((error) => console.error("Error:", error));
      }

      function goToMyPage() {
        window.location.href = "http://localhost:5001/mypage";
      }
    </script>
  </head>
  <body>
    <h1>{{ message }}</h1>
  </body>
</html>
